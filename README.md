# Container Scanning 2 - Node.js Pull Request Policy Demo

This repository demonstrates **Arnica's Pull Request policy with automated labeling** capabilities using a Node.js-based container.

## Purpose

This repo showcases Arnica's ability to automatically add labels to pull requests when Dockerfile changes are detected, enabling better PR categorization and automated workflows.

## Repository Contents

### Required Files to Copy to Destination Repository

When setting up a new repository based on this template, copy the following files:

#### 1. `.gitignore`
- Excludes `node_modules` from version control
- Location: Root directory
- Contents:
  ```
  node_modules
  ```

#### 2. `.github/workflows/docker.yaml`
- GitHub Actions workflow for building and pushing Docker images
- Triggers on push to `main` branch
- Includes semantic versioning and multi-platform builds
- Location: `.github/workflows/`

#### 3. `awsome-content.Dockerfile`
- Node.js 22.18.0-based Dockerfile with intentional vulnerabilities
- Contains `aws-sdk@2.1297.0` and `libxml` (known issues)
- Installs dependencies from `package.json`
- Location: Root directory

#### 4. `package.json`
- Node.js project dependencies including:
  - `express`, `axios`, `lodash`, `dotenv`, `uuid`
  - `http-proxy-agent@1.0.0` (older version with vulnerabilities)
  - Dev dependency: `nodemon`
- Location: Root directory

#### 5. `package-lock.json`
- Lock file for reproducible npm installs
- Auto-generated by `npm install`
- Location: Root directory

## Setup Instructions

### 1. Initial Repository Setup

```bash
# Create your destination repository on GitHub first
# Then copy the required files:

cp .gitignore /path/to/destination/repo/
cp -r .github /path/to/destination/repo/
cp awsome-content.Dockerfile /path/to/destination/repo/
cp package.json /path/to/destination/repo/
cp package-lock.json /path/to/destination/repo/
cp README.md /path/to/destination/repo/
```

### 2. Enable GitHub Actions

1. Go to your repository on GitHub
2. Navigate to **Settings** → **Actions** → **General**
3. Under "Actions permissions", select **"Allow all actions and reusable workflows"**
4. Click **Save**

### 3. Install Dependencies (if modifying)

```bash
cd /path/to/destination/repo
npm install
```

### 4. Push to Main

```bash
git add .
git commit -m "Initial setup for Arnica PR labeling demo"
git push origin main
```

### 5. Integrate with Arnica

1. Log into your Arnica account
2. Go to **Settings** → **Integrations** → **GitHub**
3. Add this repository to Arnica's monitored repositories
4. Verify webhook is installed (should be automatic)
5. Ensure Arnica has permission to add labels to PRs

### 6. Set Up Arnica Policy (Pull Request Labeling)

This repository demonstrates **PR-based policy with automated labeling**:

1. In Arnica, navigate to **Policies** → **Create New Policy**
2. Configure the policy:
   - **Name**: "Dockerfile PR Labeling - Node.js Demo"
   - **Type**: "Pull Request Policy"
   - **Trigger**: On pull request creation/update
   - **Scope**: Apply to repository `container-scanning-2` only
   - **Actions**:
     - Add label: `dockerfile-changes` when Dockerfile is modified
     - Add label: `security-review-needed` if vulnerabilities detected
     - Add label: `dependencies-updated` if package files changed
   - **Rules**: Detect changes to:
     - `*.Dockerfile`
     - `package.json`
     - `package-lock.json`
3. Save the policy

### 7. Verify Integration

After pushing changes:

1. Check GitHub Actions runs successfully
2. In Arnica dashboard:
   - Navigate to **Containers** or **Assets**
   - Verify `container-scanning-2` repository appears
   - Click on the repository to see scan results
3. Expected findings:
   - Vulnerabilities in `http-proxy-agent@1.0.0`
   - Issues in `aws-sdk@2.1297.0`
   - Multiple npm package vulnerabilities

## Testing the PR Labeling

### Create a Test Pull Request

1. **Create a new branch**:
```bash
git checkout -b test/dockerfile-update
```

2. **Make a change to the Dockerfile**:
```bash
# Add a comment or modify a package version
echo "# Updated for testing" >> awsome-content.Dockerfile
git add awsome-content.Dockerfile
git commit -m "Test: Update Dockerfile"
git push origin test/dockerfile-update
```

3. **Create a Pull Request**:
   - Go to GitHub and create a PR from `test/dockerfile-update` to `main`
   - Watch Arnica automatically add labels

4. **Expected Labels**:
   - `dockerfile-changes` - Because Dockerfile was modified
   - `security-review-needed` - If vulnerabilities detected (likely)
   - Possibly custom labels based on your Arnica policy

## How to View Results in Arnica

### Method 1: Pull Requests View
1. Go to **Pull Requests** in Arnica
2. Select `container-scanning-2` repository
3. View all PRs with Arnica-applied labels
4. Click on specific PR for detailed analysis

### Method 2: Policy Dashboard
1. Navigate to **Policies**
2. Select your "Dockerfile PR Labeling" policy
3. View:
   - How many PRs triggered the policy
   - Which labels were applied
   - Policy execution history

### Method 3: Repository View
1. Go to **Repositories** → `container-scanning-2`
2. View **Pull Requests** tab
3. See labeled PRs and their scan results

## Key Differences from container-scanning-1

- **This repo (container-scanning-2)**: Demonstrates **Pull Request policies** with automated labeling on PRs
- **container-scanning-1**: Demonstrates **line-by-line content scanning** of Dockerfiles on every commit

Both showcase different Arnica policy types:
- **container-scanning-1**: Content-based scanning (finds vulnerabilities in code)
- **container-scanning-2**: Workflow-based policy (automates PR management)

## Advanced Testing Scenarios

### Test 1: Package Updates
```bash
git checkout -b test/package-update
# Update a package in package.json
npm install express@latest
git add package.json package-lock.json
git commit -m "Update Express to latest"
git push origin test/package-update
# Create PR and watch for labels
```

### Test 2: Multiple File Changes
```bash
git checkout -b test/multi-file
# Modify both Dockerfile and package.json
echo "ENV NODE_ENV=production" >> awsome-content.Dockerfile
echo "  }" >> package.json  # Add a newline or minor change
git add awsome-content.Dockerfile package.json
git commit -m "Update Dockerfile and dependencies"
git push origin test/multi-file
# Create PR - should trigger multiple labels
```

### Test 3: Vulnerability Introduction
```bash
git checkout -b test/add-vuln
# Add an old, vulnerable package
npm install lodash@3.0.0 --save
git add package.json package-lock.json
git commit -m "Add old lodash version"
git push origin test/add-vuln
# Create PR - should trigger security labels
```

## Troubleshooting

### Actions Not Running
- Verify GitHub Actions are enabled (Settings → Actions → General)
- Check workflow file exists in `.github/workflows/`
- Review GitHub Actions tab for errors

### Arnica Not Adding Labels to PRs
- Verify repository integration includes PR permissions
- Check that policy is enabled and scoped to `container-scanning-2`
- Verify webhook is installed (Settings → Webhooks on GitHub)
- Check Arnica has "Write" permissions for PRs
- Review policy trigger conditions

### Docker Build Failing
- Ensure `node_modules` is in `.gitignore`
- Don't commit `node_modules` directory
- Verify `package-lock.json` matches `package.json`
- Check GitHub Actions logs for specific npm errors

### Labels Not Appearing
- Wait 30-60 seconds after PR creation
- Check Arnica policy execution logs
- Verify the policy conditions match your changes
- Ensure policy is active (not in "dry run" mode)

## Viewing Policy Execution in Arnica

1. **Real-time Monitoring**:
   - Navigate to **Activity** or **Audit Log**
   - Filter by repository: `container-scanning-2`
   - See when policies execute and what actions they take

2. **Policy Analytics**:
   - Go to **Policies** → Your PR Labeling Policy
   - View statistics:
     - Number of PRs processed
     - Labels applied
     - Execution success rate

3. **PR-Specific Details**:
   - Click on any PR in Arnica
   - View:
     - Which policies were triggered
     - What labels were added
     - Scan results and findings
     - Recommendations

## Additional Resources

- [Arnica Documentation](https://docs.arnica.io)
- [GitHub PR Labels Best Practices](https://docs.github.com/issues/using-labels-and-milestones-to-track-work)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)
- [npm Audit Documentation](https://docs.npmjs.com/cli/audit)

